<!DOCTYPE html>
<header>
</header>
<script src="d3.v3.min.js" charset="utf-8"></script>
<script src="underscore.js" charset="utf-8"></script>

<script>

var colors = ["#a50026","#d73027","#f46d43","#fdae61","#fee08b","#ffffbf","#d9ef8b","#a6d96a","#66bd63","#1a9850","#006837"]
var colors = ["#a50026","#d73027","#f46d43","#fdae61","#fee08b","#ffffbf","#d9ef8b","#a6d96a","#66bd63","#1a9850","#006837"]

function randomArray(length, max) {
    return Array.apply(null, Array(length)).map(function(_, i) {
        return Math.round(Math.random() * max);
    });
}

var data = {"servers": [
    {"Name":"Multiproxy1",
    "CPU": randomArray(100, 100),
    "bandwidthUP": randomArray(100, 2000),
    "bandwidthDOWN": randomArray(100, 2000),
    "Processes": [{
    "Name":"hola_bridge",
    "CPU": randomArray(100, 50),
    "RAM": Math.random()*100
    }]
  }

]}



//The SVG Container
var svgContainer = d3.select("body").append("svg")
                                    .attr("width", 600)
                                    .attr("height", 600);



var generateBall = function(data, radio){

  svgContainer.append('circle')
      .attr('id', 'circleBG')
      .attr('r', radio)
      .attr('cx', radio)
      .attr('cy', radio)
      .attr('fill', '#222222');

  var divitions = data.length;

  var currentDate = new Date()
  var miliseconds_at_midnight = new Date(currentDate.getUTCFullYear()+'-'+(currentDate.getMonth()+1)+'-'+currentDate.getDate())

  console.log(miliseconds_at_midnight)
  var miliseconds_elapsed = currentDate.getTime() - miliseconds_at_midnight.getTime()
  var percentage_elapsed = miliseconds_elapsed / 86400000
  console.log(percentage_elapsed)




  var items = _.filter(Object.keys(data[0]), function(each){ return each.indexOf("_") == -1})
  // console.log(items)
  var items = ["aut", "car", "cc", "dem", "eol", "gf", "hid", "icb", "inter", "nuc", "sol"]
  var items = [ "eol", "car","gf", "hid", "inter", "sol", "inter"]
  // var items = ["hid", "dem", "eol"]
  var itemIndex = 0
  var totalValues = {}
  _.map(items, function(item, itemIndex){
    itemizedValues = []
    var itemized_data = _.map(data, function(eachdata){return eachdata[item]})
    var maxVal = d3.max(itemized_data), minVal = d3.min(itemized_data)
    var scaleit = d3.scale.linear()
    .domain([minVal, maxVal])
    .range([10,30]);

    var pos = 0;
    for(i=0; i<2*Math.PI ; i=i+2*Math.PI/divitions){
      if(typeof(itemized_data[pos]) == 'number'){

        if(totalValues[pos] == undefined){
          totalValues[pos] = 0
        }

        value = scaleit(itemized_data[pos])
        if(value<0){
          value = -1*value
        }

        itemizedValues.push({"pos":i, "value": value, "previousValue": totalValues[pos], "transparency": 1-(divitions-pos)/divitions+0.3})

        totalValues[pos] = totalValues[pos] + value

        pos++;
      }
    }

    var arc = d3.svg.arc()
        .innerRadius(function(d){return d.previousValue})
        .outerRadius(function(d){return d.previousValue+d.value})
        .startAngle(function(d){return d.pos})
        .endAngle(function(d){return d.pos+2*Math.PI/divitions});

        svgContainer.selectAll("g").data(itemizedValues).enter().append('path')
            .attr("d", arc).attr("opacity", function(d){return d.transparency})
.attr("transform", "translate("+radio+","+radio+") rotate("+(180+percentage_elapsed*360)+") ")
            .attr('fill', colors[itemIndex]);


  })



    var hours = _.range(24);
    var hours_positions = _.map(hours, function(hour){
      var angle = hour / 24 * 2 * Math.PI;
      if(hour.toString().length == 1){
        hour = '0'+hour
      }
      return {cx: -(radio*0.93)*Math.sin(angle), cy: (radio*0.95)*Math.cos(angle), text: hour+':00'}
    })

    var text = svgContainer.selectAll("text")
                          .data(hours_positions)
                          .enter()
                          .append("text");


    var textLabels = text
                     .attr("x", function(d) { return d.cx; })
                     .attr("y", function(d) { return d.cy; })
                     .text( function (d) { return d.text; })
                     .attr("font-family", "sans-serif")
                     .attr("font-size", (10/300*radio)+"px")
                     .attr("fill", "white")
                     .attr("transform", "translate("+(radio*0.95)+","+(radio*1.005)+")");
}

d3.json("http://192.168.0.24:8000/last24h.json", function(error, data){
  data.reverse();
  generateBall(data, 300)

})








// var subdivitions = 60
// var randomValues = []
// for(i=0; i<2*Math.PI ; i=i+Math.PI/subdivitions){
//   randomValues.push([i, 100+Math.round(Math.random() * 100)])
// }
//
// var arc = d3.svg.arc()
//     .innerRadius(function(d){console.log(d);return d[1]})
//     .outerRadius(300)
//     .startAngle(function(d){return d[0]})
//     .endAngle(function(d){return d[0]+Math.PI/subdivitions});
//
// // svgContainer.selectAll("g")
// //   data(randomValues).enter().
//
//
// svgContainer.selectAll("g").data(randomValues).enter().append('path')
//     .attr("d", arc).attr("cx", function(){return 120})
//     .attr("cy", function(){return 30}).attr("transform", "translate(300,300)").
//     attr('fill', '#BD10E0');

</script>
<body>
</body>
