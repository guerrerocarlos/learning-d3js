<!DOCTYPE html>
<header>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BigView</title>
  <link rel="stylesheet" href="css/foundation.css">
  <link rel="stylesheet" href="css/app.css">
</header>
<script src="d3.v3.min.js" charset="utf-8"></script>
<script src="underscore.js" charset="utf-8"></script>

<script>
  var main_colors = ["#a50026", "#d73027", "#f46d43", "#fdae61", "#fee08b", "#ffffbf", "#d9ef8b", "#a6d96a", "#66bd63", "#1a9850", "#00aa00", "rgb(255, 215, 0)"]

  function randomArray(length, max) {
    return Array.apply(null, Array(length)).map(function(_, i) {
      return Math.round(Math.random() * max);
    });
  }





  //The SVG Container
  var svgContainer = d3.select("body").append("svg")
    .attr("width", 600)
    .attr("height", 600);



  var last_ihours = false
  var background_painted = false
  var text_labels
  var last_hours_positions
  var existing_arcs = []
  var previously_itemized_values = []


  var generateBall = function(data, radio, ihours, type, assigned_colors) {


    if (type == undefined) {
      var maxVal = 0
      var scaleit
    } else {
      var maxVal = []
      var scaleit = []
    }
    console.log('generate new Ball')
      // ihours = 24

    if (!background_painted) {
      var circle = svgContainer.append('circle')
        .attr('id', 'circleBG')
        .attr('r', radio)
        .attr('cx', radio)
        .attr('cy', radio)
        .attr('fill', '#222222');
    }
    background_painted = true

    if (last_ihours != ihours) {

      if (ihours == 24) {
        var hours = _.range(24);
        var hours_positions = _.map(hours, function(hour) {
          var angle = hour / 24 * 2 * Math.PI;
          if (hour.toString().length == 1) {
            hour = '0' + hour
          }
          return {
            cx: -(radio * 0.93) * Math.sin(angle),
            cy: (radio * 0.95) * Math.cos(angle),
            text: hour + ':00'
          }
        })
      } else {
        var num = 12
        var hours = _.range(num);
        var minutes = 0
        var hours_positions = _.map(hours, function(hour) {
          var angle = hour / num * 2 * Math.PI;
          var minutes = hour * (60 / num)
          var now = new Date()

          if (minutes.toString().length == 1) {
            minutes = '0' + minutes
          }
          left_hour = ""
          if (now.getHours().toString().length == 1) {
            left_hour = "0"
          }

          return {
            cx: (radio * 0.93) * Math.sin(angle),
            cy: -(radio * 0.95) * Math.cos(angle),
            text: left_hour + now.getHours() + ":" + minutes
          }
        })
      }

      if (last_ihours == false) {
        text_labels = svgContainer.selectAll("text")
          .data(hours_positions)
          .enter()
          .append("text");

        text_labels
          .attr("x", function(d) {
            return d.cx;
          })
          .attr("y", function(d) {
            return d.cy;
          })
          .text(function(d) {
            return d.text;
          })
          .attr("font-family", "sans-serif")
          .attr("font-size", (10 / 300 * radio) + "px")
          .attr("fill", "white")
          .attr("transform", "translate(" + (radio * 0.95) + "," + (radio * 1.005) + ")");

        last_hours_positions = hours_positions

      } else {
        if (last_ihours == 1 && ihours == 24) {
          only_hour = []
          _.each(hours_positions, function(value, index) {
            if (value.text == last_hours_positions[0].text) {
              only_hour.push(value)
            }
          })
        }

        text_labels
          .data(only_hour)
          .exit() //.transition()
          // .duration(1000)
          //.attr("fill", "black")
          .remove()

        text_labels
          .data(only_hour)
          .transition()
          .duration(2000)
          .attr("x", function(d) {
            return d.cx;
          })
          .attr("y", function(d) {
            return d.cy;
          })
          .text(function(d) {
            if (d != undefined) {
              return d.text;
            } else {
              return 'd.text';

            }
          })

        new_hours_positions = only_hour
        _.each(hours_positions, function(each, pos) {
          if (each.text != only_hour[0].text) {
            new_hours_positions.push(each);
          }
        })

        text_labels = svgContainer.selectAll("text")
          .data(new_hours_positions)
          .enter()
          .append("text")
          .attr("x", function(d) {
            return d.cx;
          })
          .attr("y", function(d) {
            return d.cy;
          })
          .text(function(d) {
            return d.text;
          })
          .attr("font-family", "sans-serif")
          .attr("font-size", (10 / 300 * radio) + "px")
          .attr("fill", "white")
          .attr("transform", "translate(" + (radio * 0.95) + "," + (radio * 1.005) + ")");
      }
    }
    last_ihours = ihours

    var divitions = data.length;

    var currentDate = new Date()

    var miliseconds_at_midnight = new Date(currentDate.getUTCFullYear() + '-' + (currentDate.getMonth() + 1) + '-' + currentDate.getDate())
    var miliseconds_elapsed = currentDate.getTime() - miliseconds_at_midnight.getTime()
    var percentage_elapsed = miliseconds_elapsed / (1000 * 60 * 60 * 24)

    if (ihours == 1) {
      var miliseconds_at_last_hour = new Date(currentDate.getUTCFullYear() + '-' + (currentDate.getMonth() + 1) + '-' + currentDate.getDate() + ' ' + currentDate.getHours() + ':00:00')
      var miliseconds_elapsed = currentDate.getTime() - miliseconds_at_midnight.getTime()
      var percentage_elapsed = miliseconds_elapsed / (1000 * 60 * 60)
    }

    // get the columns that come in the data by checking the first row
    var items = Object.keys(data[0])

    items = _.sortBy(items, function(d) {
      return d
    })

    var total_values = {}
    _.map(items, function(item, itemIndex) {

      var itemized_data_values = _.map(data, function(eachdata) {
        if(eachdata[item]['max_val']>0){
          console.log('has max_val, using it: '+eachdata[item]['max_val'])
          return eachdata[item]['max_val']
        } else {
          return eachdata[item]['value']
        }
      })

      if (type == undefined) {
        if (maxVal == undefined) {
          maxVal = 0
        }
        maxVal += d3.max(itemized_data_values)

        scaleit = d3.scale.linear()
          .domain([0, maxVal])
          .range([0, radio * 0.90]);

      } else {
        if (maxVal[itemIndex] == undefined) {
          maxVal[itemIndex] = 0
        }
        maxVal[itemIndex] += d3.max(itemized_data_values)
        console.log('generating scale linear with max as: ' + maxVal[itemIndex])
        scaleit[itemIndex] = d3.scale.linear()
          .domain([0, maxVal[itemIndex]])
          .range([0, radio * 0.90]);
      }

    })

    var all_previously_existing_items = Object.keys(existing_arcs)

    _.map(items, function(item, itemIndex) {
      console.log("Processing " + item + " with itemIndex: " + itemIndex)
      all_previously_existing_items.splice(all_previously_existing_items.indexOf(itemIndex.toString()), 1)
      itemized_values = []

      var itemized_data = _.map(data, function(eachdata) {
        return eachdata[item]
      })

      var pos = 0;
      for (i = 0; i < 2 * Math.PI; i = i + 2 * Math.PI / divitions) {
        if (itemized_data[pos] != undefined && typeof(itemized_data[pos]['value']) == 'number') {
          if (total_values[pos] == undefined) {
            total_values[pos] = 0
          }
          //console.log(itemized_data[pos]['value'])

          if (type == undefined) {
            value = scaleit(itemized_data[pos]['value'])
          } else {
            value = scaleit[itemIndex](itemized_data[pos]['value'])
          }

          //console.log(value)

          if (value < 0) {
            value = -1 * value
          }
          //console.log(itemized_values)
          itemized_values.push({
            "pos": i,
            "itemIndex": itemIndex,
            "value": value,
            "previousValue": total_values[pos],
            //"transparency": 0.7
            "transparency": 1 - (divitions - pos) / (divitions) + 0.3
          })
          total_values[pos] = total_values[pos] + value
        }
        pos++;

      }
      var to_rotate = -180 + percentage_elapsed * 360
      if (ihours == 1) {
        var to_rotate = percentage_elapsed * 360
      }

      console.log()

      function paint_arcs(itemized_values, radio, to_rotate, itemIndex, server_name) {
        if (type == undefined) {
          var arc = d3.svg.arc()
            .innerRadius(function(d) {
              // return d.previousValue
              return d.previousValue;
            })
            .outerRadius(function(d) {
              return d.value + d.previousValue;
            })
            .startAngle(function(d) {
              return d.pos
            })
            .endAngle(function(d) {
              return d.pos + 2 * Math.PI / (divitions)
            });
        } else {
          var arc = d3.svg.arc()
            .innerRadius(function(d) {
              // return d.previousValue
              return 0;
            })
            .outerRadius(function(d) {
              return d.value;
            })
            .startAngle(function(d) {
              return d.pos + (2 * Math.PI / (divitions) / 2) * (d.itemIndex - 1)
            })
            .endAngle(function(d) {
              return d.pos + 2 * Math.PI / (divitions) / 2 + (2 * Math.PI / (divitions) / 2) * (d.itemIndex - 1)
            });
        }


        if (previously_itemized_values[itemIndex] == null) {
          existing_arcs[itemIndex] = svgContainer.selectAll("g").data(itemized_values, function(d) {
              return d.pos
            }).enter().append('path')
            .attr("d", arc).attr("opacity", function(d) {
              return d.transparency
            })
            .attr("transform", "translate(" + radio + "," + radio + ") rotate(" + to_rotate + ") ")
            .attr('fill', assigned_colors[itemIndex])
            .on('click', function(d) {
              console.log(d)
            })

          previously_itemized_values[itemIndex] = itemized_values
        } else {
          console.log('should be transitioning now!')
          existing_arcs[itemIndex].data(itemized_values).transition()
            .duration(1000)
            .attr("d", arc).attr("opacity", function(d) {
              return d.transparency
            })
            .attr("transform", "translate(" + radio + "," + radio + ") rotate(" + to_rotate + ") ")
            .attr('fill', assigned_colors[itemIndex]);

          // existing_arcs[itemIndex].data(itemized_values, function(d) {
          //     return d.id
          //   }).enter().append('path')
          //   .attr("d", arc).attr("opacity", function(d) {
          //     return d.transparency
          //   })
          //   .attr("transform", "translate(" + radio + "," + radio + ") rotate(" + to_rotate + ") ")
          //   .attr('fill', assigned_colors[itemIndex]);

        }



      }

      paint_arcs(itemized_values, radio, to_rotate, itemIndex, item)

    })
    console.log('removing previously existing ones: ' + all_previously_existing_items)
    _.each(all_previously_existing_items, function(each) {
      existing_arcs[each].data([]).exit()
        .transition()
        .attr("opacity", 0)
    })



  }


  var user = {
    name: 'Carlos Guerrero',
    services: [{
      name: 'Mediahint',
      servers: [{
        longview: '88F48041-B897-A5FB-88B706D42D45A501',
        pm2: 'holaproxy1'
      }, {
        longview: '88F48041-B897-A5FB-88B706D42D45A502',
        pm2: 'holaproxy2'
      }, {
        longview: '88F48041-B897-A5FB-88B706D42D45A503',
        pm2: 'holaproxy3'
      }, {
        longview: '88F48041-B897-A5FB-88B706D42D45A504',
        pm2: 'holaproxy4'
      }, {
        longview: '88F48041-B897-A5FB-88B706D42D45A505',
        pm2: 'holaproxy5'
      }, {
        longview: '88F48041-B897-A5FB-88B706D42D45A506',
        pm2: 'holaproxy6'
      }]
    }]
  }

  var config = {
    ball_radius: 300
  }

  var servers_graphs = {}


  function get_last_hour_of(server) {
    // server_list = _.map(user.services[0].servers, function(each) {
    //   return each.longview
    // })
    // server_list = ['88F48041-B897-A5FB-88B706D42D45A502']
    var server_list = []
    server_list.push(server)
    _.each(server_list, function(value, key, list) {
      servers_logs = []
      d3.json("http://longview.carlosguerrero.com:8090/get/" + value + "/" + (120), function(err, server_logs) {
        if (server_logs.length > 100)
          servers_logs = []
        server_logs.reverse()
        _.each(server_logs, function(value, key, list) {

          if (servers_logs[key] == undefined) {
            servers_logs[key] = {}
          }

          servers_logs[key][value.apikey] = {
            value: value.Memory_real_used,
            id: value.apikey + value.timestamp
          };
        })
        generateBall(servers_logs, config.ball_radius, 1, main_colors)
      })
    })
  }

  function get_of(server_list, server_keys, hours, type, colors) {
    console.log('in get_of')

    _.each(server_list, function(value, list_key, list) {
      servers_logs = []
      d3.json("http://longview.carlosguerrero.com:8090/get/" + value + "/" + (120 * hours), function(err, server_logs) {
        server_logs.reverse()
        _.each(server_keys, function(each_server_key) {

          _.each(server_logs, function(value, key, list) {

            if (servers_logs[key] == undefined) {
              servers_logs[key] = {}
            }
            var max_val = 0
            if (each_server_key.indexOf('Mem') > -1) {
              max_val = value.Memory_real_used + value.Memory_real_free
            }

            if (each_server_key.indexOf('load') > -1) {
              max_val = 1.25
            }

            servers_logs[key][value.apikey + each_server_key] = {
              value: value[each_server_key],
              max_val: max_val
            };
          })

        })

        generateBall(servers_logs, config.ball_radius, 1, type, colors)

      })

    })

  }

  function get_all_last_hour_bandwidth() {
    server_list = _.map(user.services[0].servers, function(each) {
        return each.longview
      })
      // server_list = ['88F48041-B897-A5FB-88B706D42D45A504', '88F48041-B897-A5FB-88B706D42D45A502']
      //var server_list = []
      //server_list.push(server)
    _.each(server_list, function(value, server_position_in_list, list) {
      servers_logs = []
      d3.json("http://longview.carlosguerrero.com:8090/get/" + value + "/" + (120), function(err, server_logs) {
        server_logs.reverse()
        _.each(server_logs, function(value, i, list) {

          if (servers_logs[i] == undefined) {
            servers_logs[i] = {}
          }

          servers_logs[i][value.apikey] = {
            value: value.rx_Kbps,
          };
        })

        console.log(main_colors)
        generateBall(servers_logs, config.ball_radius, 1, undefined, main_colors)
      })
    })
  }


  function get_last_day() {
    // server_list = _.map(user.services[0].servers, function(each){ return each.longview})
    server_list = _.map(user.services[0].servers, function(each) {
      return each.longview
    })
    server_list = ['88F48041-B897-A5FB-88B706D42D45A502']

    _.each(server_list, function(value, key, list) {
      servers_logs = []
      d3.json("http://longview.carlosguerrero.com:8090/get/" + value + "/" + (2880), function(err, server_logs) {
        if (server_logs.length > 100)
          servers_logs = []
        server_logs.reverse()
        _.each(server_logs, function(value, key, list) {
          if (servers_logs[key] == undefined) {
            servers_logs[key] = {}
          }
          servers_logs[key][value.apikey] = {
            value: value.Memory_real_used,
            id: value.apikey + value.timestamp
          };
        })
        generateBall(servers_logs, config.ball_radius, 24)
      })
    })
  }

  function nodes_tree(width, height) {
    var treeContainer = d3.select("body").append("svg")
      .attr("width", width)
      .attr("height", height);

    var tree_container = treeContainer.selectAll("text.title").data(user.services)
      .enter().append('text')

    var textLabels = tree_container
      .attr("x", function(d, i) {
        return 10
      })
      .attr("y", function(d, i) {
        return 20 + 40 * i;
      })
      .text(function(d, i) {
        return d.name;
      })
      .attr("font-family", "sans-serif")
      .attr("font-size", "20px")
      .attr("fill", "black")


    _.each(user.services, function(service) {

      var tree_container = treeContainer.selectAll("text.server").data(service.servers)
        .enter().append('g').append('text')

      var textLabels = tree_container
        .attr("x", function(d, i) {
          return 20
        })
        .attr("y", function(d, i) {
          return 60 + 40 * i;
        })
        .text(function(d, i) {
          return d.pm2;
        })
        .attr("font-family", "sans-serif")
        .attr("font-size", "20px")
        .attr("fill", "grey")
        .on("click", function(d, i) {
          // get_last_hour_of(d.longview)
          var test_list = []
          test_list.push(d.longview)
          get_of(test_list, ['load', 'Memory_real_used'], 1, 'twin', ["rgb(255, 215, 0)", "#00aa00"])
        })


      // servers graphs
      // each of the servers
      servers_graphs_array = []
      servers_graphs = {}
      ports_list_containers = []

      function update_values_every(timeout, servers, key, order) {
        var painted = false;
        var tree_container = {}
        var items = [{
            key: "load",
            pos: 0
          }, {
            key: "Memory_real_used",
            pos: 1
          }, {
            key: "swap",
            pos: 1
          }, {
            key: "ports",
            pos: 2,
            type: 'text'
          }]
          // var items = [{key: "load", pos: 0}, {key: "memory", pos:1}]

        if (painted == false) {
          _.each(items, function(item) {
            var key = item.key
            var type = item.type
            _.each(servers, function(each_server) {
              // populate initial empty graphs with proper key IDs for right visual order
              servers_graphs_array.push(each_server)
              servers_graphs[each_server.longview] = each_server
            });

            if (type != undefined && type.indexOf('text') > -1) {

            } else {
              tree_container[key] = treeContainer.selectAll("bar." + key).data(servers_graphs_array, function(d) {
                  return d.longview
                })
                .enter().append('rect')
              tree_container[key].attr("x", 150)
                .attr("y", function(d, i) {
                  return 45 + 40 * i;
                })
                .attr("width", 1)
                .attr("height", 10)
                .on('click', function(d){
                  console.log(d)
                  if(key.indexOf('Mem')>-1){
                    bars_color = 'rgb(255, 215, 0)'
                  } else {
                    bars_color = '#00aa00'
                  }
                  get_of([d.apikey], [key], 1, undefined, [bars_color])
                })
            }

          })

          painted = true
        }

        function update_now() {

          _.each(servers, function(each_server) {

            d3.json("http://longview.carlosguerrero.com:8090/get/" + each_server.longview + "/1",
              function(err, server_log) {

                _.each(items, function(item) {

                  key = item.key
                  order = item.pos
                  type = item.type

                  if (type != undefined && type.indexOf('text') > -1) {

                    var this_server = server_log[0].apikey //.replace(/-/g,'')
                    var pos = Object.keys(servers_graphs).indexOf(each_server.longview)

                    server_log[0].Ports_listening = _.sortBy(server_log[0].Ports_listening, function(each) {
                      return each.port
                    })

                    _.each(server_log[0].Ports_listening, function(each) {
                      each.pos = pos
                    })

                    if (ports_list_containers[this_server] == undefined) {
                      ports_list_containers[this_server] = treeContainer.selectAll("text.ports" + this_server)
                        .data(server_log[0].Ports_listening)
                        .enter().append('text')

                      this_ports_list_container = ports_list_containers[this_server]
                    } else {
                      this_ports_list_container = ports_list_containers[this_server].data(server_log[0].Ports_listening).transition()
                    }

                    this_ports_list_container.attr("y", 10).attr("font-size", "9px")
                      .attr("x", function(d, i) {
                        return 150 + i * 40
                      })
                      .attr("y", function(d, i) {
                        return 72 + d.pos * 40
                      })
                      .style("fill", function(d) {
                        if (d.ip.indexOf('127.0.0.1') > -1) {
                          return 'grey'
                        } else {
                          return 'black'
                        }
                      })
                      .text(function(d) {
                        return d.port
                      })
                      // .append("svg:title").text(function(d){return d.name + " ("+d.type+" "+d.ip+":"+d.port+") "+d.user });



                  } else {
                    servers_graphs[each_server.longview] = server_log[0]
                    servers_graphs[each_server.longview].longview = servers_graphs[each_server.longview].apikey
                    servers_graphs_array = []
                    _.each(servers_graphs, function(each) {
                      servers_graphs_array.push(each)
                    })

                    tree_container[key].data(servers_graphs_array, function(d) {
                        return d.longview
                      })
                      .transition().attr("x", 150)
                      .attr("y", function(d, i) {
                        return 43 + 40 * i + (10 * order);
                      })
                      .attr("width", function(d, i) {
                        if (d.timestamp) {
                          if (key.indexOf('Mem') > -1) {
                            var memory_total = d.Memory_real_free + d.Memory_real_used
                            return (d.Memory_real_used / memory_total * width * 0.7)
                          }
                          if (key.indexOf('swap') > -1) {
                            var memory_total = d.Memory_real_free + d.Memory_real_used
                            return (d.Memory_swap_used / memory_total * width * 0.7)
                          }
                          return d[key] * width * 0.7
                        } else {
                          return 1
                        }
                      })
                      .style("fill", function() {
                        if (key.indexOf('load') > -1) {
                          return '#00aa00';
                        }
                        if (key.indexOf('Mem') > -1) {
                          return 'gold';
                        }
                        if (key.indexOf('swap') > -1) {
                          return 'red';
                        }
                      })
                      .attr("height", 10);

                  }


                })


              })
          })

          setTimeout(function() {
            update_now()
          }, timeout * 1000)
        }
        update_now()

      }


      update_values_every(30, service.servers, 'load', 0)


      // _.each(service.servers, function(server){
      //
      // })
    })
  }

  window.onload = function() {
    var button = document.getElementById('change1')
    button.addEventListener("click", function() {
      console.log('click action...')
      get_last_day()
    })

    var button = document.getElementById('allbandwidth')
    button.addEventListener("click", function() {
      get_all_last_hour_bandwidth()
    })

    test_list = ['88F48041-B897-A5FB-88B706D42D45A504']
      //get_of(test_list, ['load', 'Memory_real_used'], 1)
    get_all_last_hour_bandwidth()
    nodes_tree(600, 600)
  }
</script>

<body>
  <button id="change1" type="button" class="alert button">24h</button>
  <button id="allbandwidth" type="button" class="alert button">All</button>
</body>
